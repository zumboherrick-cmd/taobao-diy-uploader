name: Publish ready-made ZIP (Full Project)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build_and_release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install zip
        run: sudo apt-get update && sudo apt-get install -y zip

      - name: Build ZIP (full project)
        shell: bash
        run: |
          set -e
          ROOT="taobao_DIY_win_exe_ready"
          mkdir -p "$ROOT/backend" "$ROOT/frontend"

          # === backend files ===
          printf "from fastapi import FastAPI\napp=FastAPI()\n@app.get('/')\ndef hi():return {'ok':True}\n" > "$ROOT/backend/app.py"
          printf "fastapi\nuvicorn\npillow\nopenai>=1.0.0\n" > "$ROOT/backend/requirements.txt"
          printf "@echo off\r\ncd /d %%~dp0\r\nif not exist .venv (py -m venv .venv)\r\ncall .venv\\Scripts\\activate\r\npip install -r requirements.txt\r\npython app.py\r\n" > "$ROOT/backend/run-backend.bat"

          # === frontend files ===
          printf "{\n  \"name\": \"diy-uploader\",\n  \"version\": \"0.2.0\",\n  \"main\": \"main.js\",\n  \"scripts\": {\"start\": \"electron .\"},\n  \"devDependencies\": {\"electron\": \"^29.0.0\"}\n}\n" > "$ROOT/frontend/package.json"
          printf "const { app, BrowserWindow } = require('electron');\nfunction createWindow(){const w=new BrowserWindow({width:960,height:720,webPreferences:{nodeIntegration:true,contextIsolation:false}});w.loadFile('index.html');}\napp.whenReady().then(createWindow);\n" > "$ROOT/frontend/main.js"
          printf "<!doctype html><html><body><h1>DIY配件上新助手</h1><p>运行成功。</p></body></html>\n" > "$ROOT/frontend/index.html"

          # === readme ===
          printf "# Windows 可执行版\n\n- 后端运行：backend\\run-backend.bat\n- 前端运行：npm start\n" > "$ROOT/README_win_exe.md"

          # === zip ===
          (cd "$ROOT" && zip -r "../taobao_DIY_win_exe_ready_20251108_081529.zip" .)

      - name: Release ZIP
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "v${{ github.run_number }}"
          name: "Ready-made ZIP (Full Project)"
          body: "自动生成完整工程包（Win EXE + GPT + 图片优化）"
          files: "taobao_DIY_win_exe_ready_20251108_081529.zip"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
