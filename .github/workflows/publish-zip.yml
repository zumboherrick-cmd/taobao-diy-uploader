name: Publish ready-made ZIP

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build_and_release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install zip
        run: sudo apt-get update && sudo apt-get install -y zip

      - name: Build ZIP (minimal, ASCII only)
        shell: bash
        run: |
          set -e
          mkdir -p taobao_DIY_win_exe_ready/backend taobao_DIY_win_exe_ready/frontend
          # backend/app.py
          printf "print('backend ok')\n" > taobao_DIY_win_exe_ready/backend/app.py
          # backend/requirements.txt
          printf "fastapi\nuvicorn\npillow\nopenai>=1.0.0\n" > taobao_DIY_win_exe_ready/backend/requirements.txt
          # backend/run-backend.bat
          printf "@echo off\r\ncd /d %%~dp0\r\npython app.py\r\n" > taobao_DIY_win_exe_ready/backend/run-backend.bat
          # frontend/package.json
          printf "{\n  \"name\": \"diy-uploader\",\n  \"version\": \"0.0.1\",\n  \"main\": \"main.js\",\n  \"scripts\": {\"start\": \"electron .\"},\n  \"devDependencies\": {\"electron\": \"^29.0.0\"}\n}\n" > taobao_DIY_win_exe_ready/frontend/package.json
          # frontend/main.js
          printf "console.log('frontend ok');\n" > taobao_DIY_win_exe_ready/frontend/main.js
          # README
          printf "# Ready ZIP\n\nMinimal artifact for release test.\n" > taobao_DIY_win_exe_ready/README.md
          # zip
          (cd taobao_DIY_win_exe_ready && zip -r ../taobao_DIY_win_exe_ready_20251108_081529.zip .)

      - name: Release ZIP
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "v${{ github.run_number }}"
          name: "Ready-made ZIP"
          body: "Auto-generated minimal artifact (will expand after passing)."
          files: "taobao_DIY_win_exe_ready_20251108_081529.zip"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
